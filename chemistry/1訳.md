> タイトル<br>

<br>

RetroXpert: Decompose Retrosynthesis Prediction Like A Chemist
***

> 論文リンク<br>

<br>

https://papers.nips.cc/paper/2020/hash/819f46e52c25763a55cc642422644317-Abstract.html
***

> 要約<br>

<br>

再合成とは、標的分子をビルディングブロックに再帰的に分解するプロセスであり、有機合成計画の問題解決に重要な役割を果たす。  
逆合成解析の自動化や支援のために、様々なアルゴリズムが提案されているが、その多くは煩雑であり予測値の解釈性に欠けている。  
本論文では、化学者が逆合成を予測する方法にヒントを得て、新しいテンプレートフリーの自動逆合成展開アルゴリズムを考案  
我々の手法は、逆合成を2つのステップに分解する  
i) 新しいグラフニューラルネットワークを用いて標的分子の潜在的な反応中心を特定し、中間シントンを生成  
ii) ロバストな反応物生成モデルを用いてシントンに関連する反応物を生成  
我々のモデルは、最先端のベースラインを大幅に上回る性能を持つ一方で、化学的に合理的な解釈を提供している。
***

> Introduction  

化合物の再合成は、反応構成要素の集合に分解して構築する。  
現在では現代化学社会の基本的なパラダイムの一つ。  
これまでに報告されている有機合成の知識は 10**7 の反応と化合物から構成されています  
一方で、再合成はかなりの専門知識と経験を必要とする    
分子の合成には複数のルートが存在する場合があり、反応物の利用可能性、反応条件、反応収率、および副生成物などの複数の要因によって決定するため、適切なルートを選択することは困難である。  
本研究では、従来の方法に倣って、レトロシンセシスのシングルステップ版（生成物から可能性のある反応物を予測する）に焦点を当てている。  
我々の方法は2つのサブタスクに分解できる
> i) ターゲット分子を、開始反応物のシンソンに分解する  
ii) 得られたシンソンを対応する反応物のセットに較正する  

新規分子の合成経路設計を支援するために様々な計算手法が開発されてきたが、これらの手法は大きく分けてテンプレートベースとテンプレートフリーの2つのカテゴリーに分けられる  

### テンプレートベース  

手書きでエンコードされたルールや反応テンプレートに基づいて設計  
Synthia（旧Chematica）は手書きでエンコードされた反応変換ルールに依存しているが、反応数が指数関数的に増加していることを考えると、すべての合成ルートを手動でエンコードすることは非現実的    
欠点：：テンプレートデータベースがカバーする化学空間内の反応しか推論できない、新規な反応を発見することができない  

### テンプレートフリー  
分子をSMILESの文字列として表現することができるため、再合成をneural machine translationとして扱う。  
単純で表現力があるが、化学者の分析プロセスには馴染まないし、解釈性にも欠ける。  
既知の化学知識を考慮に使用できない。  
我々の手法と同様に、並行して行われているG2Gsも分解と生成の2段階のフレームワークを提示  
G2Gs（graph to graph）は変分グラフ変換モデルを用いて関連するシンソンから反応物を増分的に生成することを提案している。  
しかし、G2Gsは、普遍的ではない1つの結合切断を予測することができる。  
また、G2Gsは独立して複数の反応物を生成するため複数の反応物間の関係を無視している。  

これらの課題を克服するために、我々は化学者の専門的な経験に触発されて、レトロ合成の予測を自動化するために、RetroXpertと名付けられた2段階のフレームワークを考案。  
我々のモデルは、図1に示すように、2つのステップでこれに取り組んでいる。  
i) 新しいエッジ強調グラフ注目ネットワーク（EGAT）を用いて標的分子内の潜在的な反応中心を特定する。  
反応中心は、再合成プロセスで切断される結合のセットと呼ばれています。反応中心に応じて標的分子を分割することにより、シンソンを得ることができる。  
ii) RGN（Reactant Generation Network）は、標的分子とシンソンを与えられた関連する反応物を予測する。  
これまでの方法とは異なり、我々の方法では中間的なシンソンのおかげで、反応物の生成順序を一意に決定することができます。  
さらに、RGNのロバスト性が重要な役割を果たしていることに気づく。  
RGNのロバスト性を向上させるために、我々はRGNの学習データに失敗した予測シンソンを組み込むことでRGNの学習データを増強することを提案した。  
我々の主な貢献は以下の通りである。  

1) 化学的知識で強化されたEGATを用いて潜在的な反応中心を特定  
2) ターゲット分子をシンソンに分割することで、RGNは反応物の生成順序を決定することができる。  
さらに、予測に失敗したシンソンを導入して学習データを増強することで、RGNのロバスト性を向上させ、大幅な改善を実現  
3) 標準的なUSPTO-50Kデータセットにおいて、反応タイプがw/の場合は70.4%、wo/の場合は65.5%のTop-1精度を達成しており、[5]で報告されたSOTA精度63.2%(w/)、52.6%(wo/)を大差で上回っている。  

> EGAT for reaction center identification  
反応中心の特定を前方反応結果予測と同様のグラフからグラフへの変換問題として扱う。  
分子グラフGを入力とし、各結合の断線確率を予測するグラフニューラルネットワーク(EGAT)を提案する。  
生成物は異なる反応によって生成される可能性があるため、生成物に対して複数の反応中心が存在し、各反応中心は異なる反応に対応している。  
しかし、現在のメッセージパッシングニューラルネットワークは浅く、各ノードの局所的な構造情報しか捉えておらず、  
大域的な情報がないと複数の反応中心を区別することが困難である。  
この問題を緩和するために、切断結合の総数を予測するグラフレベルの補助タスクを追加する。

***

> experiments

<br>

## dataset and reprocessing
USPTO-50KとUSPTO-full を使用  
### USPTO-50K
> USPTO(アメリカ)が付与した特許に基づいて作成。、10種類の反応タイプでアノテーションされた50Kの反応から構成  
> 以前のレトロシンセシスの研究で広く利用されている。学習/検証/テスト 8:1:1分割
RGN（Reactant Generation Network、反応生成ネットワーク） の学習データについて
> 2つ以上のsynthonsがある場合：synthonが逆になっている28Kのサンプルを追加（図3）
> RGN学習サンプルは６８Ｋあり、以下の内容ではUSPTO-50Kと表記したまま  

### USPTO-full
> USPTO-50K 197-2016からの950Kのクリーン化された反応で構成、反応タイプのない生の反応は1808937件
> 複数の生成物を持つ反応は、複数の単一生成物のものに複製
> 無効な反応を除去し、重複排除を行うと950Kの反応が得られ、これを8:1:1の割合でトレーニング/バリデーション/テストセットにランダムに分割  

### EGAT  
> DGLを用いて分子グラフを作成し、RDkitを用いて原子と結合の特徴を抽出  
生成物と反応物の分子グラフを比較し、生成物グラフ内の断線結合を識別し、主タスクと補助タスクの両方の学習ラベルを得ることができる（主タスクと補助タスク？）  
この比較は、アトムマップされた反応に対して簡単に行うことができる  
アトムマップされていない反応については、RDKitの部分構造マッチングアルゴリズムを利用して比較を行う  
一般的な反応テンプレートを抽出するためにRDChiralを使用し、USPTO-50Kのトレーニングデータのために1859の半テンプレートを取得  
2回以下出現する半テンプレートはフィルタリングされ、最終的に654個の半テンプレートが得られる  
RGNについては、生成分子グラフを基底真理反応中心に応じてsynthonsグラフに分割し、SMILES文字列に変換
RGNの入力シーケンスは図3に示すように、可能な反応タイプ、生成物SMILESストリング、およびシンソンSMILESストリングの連結。
***

### Reactant generation network
反応中心が特定されるとシンソンを得ることができる。  
各シンソンは反応物内の部分構造であるので、反応物の総数と反応物の部分構造の総数が知らされる。  
タスクＳ→Ｒは、シンソンを所望の反応物の集合を生成することである。  
RGNは以下の3つの要件を満たすことを提案する  
R1) 順列不変であり、シンソンの順序に関係なく同じ反応物の集合を生成すること  
R2) 反応物を生成する際には、与えられたすべての情報を考慮しなければならないこと  
R3) 各反応物の生成は、以前に生成された反応物にも依存すること  
これらの要件を満たすために、我々は分子をSMILESで表現し、S → Rをsequenceto-sequence予測問題として定式化する。  
RDKitを使用してシンソングラフをSMILES表現に変換します。  
図3のように、ソースシーケンスは、可能な反応タイプ、生成物の標準的なSMILES、および関連するシンソンを連結したものである。
ターゲットシーケンスは、シンソンに従って配置された所望の反応物である。

逆に配置されたシンソンと反応物でtrainのサンプルを増強することによって、要件R1を近似する。  
我々の経験的研究では、このような近似が実際にはかなりうまく機能することが実証されています。  
要件 R2 を満たすために、エンコーダ-デコーダ注意メカニズムが採用されており、ターゲットシーケンスの各位置がソースシーケンスのすべての位置に注意を払うことができます。  
RGN が要件 R3 を満たすように、デコーダ内の将来の位置をマスクする同様のマスク付き自己注意機構が採用されています。

自然な機械翻訳におけるTransformer [27]の成功に触発され、Transformerモジュールに基づいてRGNを構築します。  
Transformerは、自己注意とエンコーダ・デコーダ注意の2種類の注意メカニズム[27]を備えたシーケンス・ツー・シーケンスモデル(R2, R3を満たす)です。  
Transformerは、生成物と反応物の両方をSMILESで表現する反応結果予測[28]やレトロシンセシス[6]にも適応されています  

## Determine the generation order of reactants
反応物に一意に関連付けられた中間シンソンのおかげで、ターゲットの反応物をソースのシンソンに整列させることによって、初めて反応物の生成順序を決定することができます。  
これまでの方法[4, 6, 15]では、反応物の生成順序は不確定であったが、シーケンス間のモデルをブラックボックスのように単純に扱っていた。  

## Robustify the RGN
EGATが複数の反応中心が共存しているかどうかを区別することに悩んでいることを発見し、これが我々の手法の大きなボトルネックとなっている。  
反応中心の識別に失敗した結果、生成されたシンソンは基底真実とは異なるものになってしまう。  
EGATが反応中心の認識に失敗した場合でも、RGNを十分にロバストにして目的の反応物を予測できるようにするために、予測に失敗したシンソンを学習データに含めることで、RGNの学習データをさらに増強する。図３のようにシンソンの順番を逆にすることはしない。これは、学習データとテストデータが同じ分布をたどっているため、EGATが同じようなミスをする傾向があるからである。この方法により、我々のRGNは反応中心予測誤差を修正し、目的とする反応物のセットを生成することができるようになる。

## EGAT for reaction center identification
我々は、反応中心の特定を前方反応結果予測[21]と同様のグラフからグラフへの変換問題として扱う。これを実現するために、我々は分子グラフGを入力とし、各結合の断線確率を予測するグラフニューラルネットワーク(EGAT)を提案する。生成物は異なる反応によって生成される可能性があるため、ある生成物に対して複数の反応中心が存在し、各反応中心は異なる反応に対応している。しかし、現在のメッセージパッシングニューラルネットワーク[22]は浅く、各ノードの局所的な構造情報しか捉えておらず、大域的な情報がないと複数の反応中心を区別することが困難である。この問題を緩和するために、切断結合の総数を予測するグラフレベルの補助タスクを追加する。

図2に示すように、ノードやグラフレベルの埋め込みを学習するように設計されたグラフアテンションネットワーク(Graph Attention Network: GAT) [23]とは異なり、我々の提案するEGATはエッジ埋め込みも学習する。これは、エッジ埋め込みを入力として、各結合の切断確率を予測することで反応中心を特定する。ターゲットG = {A, E, X}が与えられると、EGAT層は、前の層の埋め込みhi,pi,jからノード埋め込みh 0 iとエッジ埋め込みp 0 i,jを次の式で計算する。

## Atom and bond features
原子特徴量は、原子の種類、混成、形式電荷などの一般的な原子情報から構成され、結合特徴量は、結合の種類や共役などの化学結合４の情報から構成される（詳細は付録Ｂを参照のこと）。これらの特徴は、化学的性質予測のための [24] で用いられているものと同様である。これらの特徴は、オープンソースのツールキットRDKit 4を用いて計算しています。USPTOデータセット[19] [25]の豊富なアトムマッピング情報をフルに活用するために、アトム特徴量に半テンプレート指標を追加しています。また，与えられた反応タイプを持つレトロシンセシスデータセットに対しては，アトムフィーチャにタイプインジケータを追加しています。

## Semi-template
USPTOデータセットでは、以前のテンプレートベースの手法[12, 14, 5]と同様に、反応データから反応テンプレートが抽出される。しかし、これらのテンプレートはあまりにも特殊なものであることが多いため、完全な反応テンプレートには興味がありません。USPTO-50Kトレインデータには11,647個ものテンプレートがある[5]。代わりにproductのテンプレートのみを保存しており、これをセミテンプレートと呼んでいます。反応テンプレートは正確な反応に密接に関連しているため、セミテンプレートは反応中心の特定に重要な役割を果たすと期待されています。半テンプレートは分子内のサブグラフパターンと考えることができる。トレーニングデータから半テンプレートのデータベースを構築し、各分子内に出現した半テンプレートをすべて見つける。各原子について、出現した半表板に関連する指標ビットをマークする。これらの半テンプレートは相互に排他的ではないので、分子内の各原子は複数の半テンプレートに属している可能性があることに注意してください。反応テンプレートが導入されていますが、私たちの方法は、i)半テンプレートのみが組み込まれており、私たちの方法は、再合成を計画するために完全なテンプレートに依存していないので、まだテンプレートフリーであり、ii)私たちのEGATは、わずかな性能低下を伴うだけで、半テンプレートがない場合でも十分に動作します（付録D.2）。

## Reaction center identification results
また、エッジ強調注意メカニズムの有効性を検証するために、係数 ci,j = LeakyReLU(a T [zi ||zj ])を計算する際に、エッジ埋め込みpi,jを除去したアブレーション研究も行った。  
補助タスク(Aux)は、反応タイプ(Type)が与えられた場合は99.2%のテスト分子に対して、与えられなかった場合は86.4%の確率で切断結合の数を予測することに成功した。

主タスク(Main)のみの予測精度は、反応の種類(Type)が与えられた場合は74.4%で、反応の種類(Type)が与えられた場合は51.5%となっている。しかし、補助タスクからの予測を切断結合数の先行値として採用し、最も確率の高い切断結合（EGAT）を選択すると、予測精度はそれぞれ86.0%(w/)、64.9%(wo/)にまで高めることができる。エッジ強化注意(EAtt)は、すべてのタスクにおいてモデルの性能を一貫して向上させることができる。この改善は反応タイプが不明な場合に顕著であり、我々のEGATは反応タイプのない実世界のアプリケーションでより実用的である。このことは、反応タイプ情報が再合成において重要な役割を果たしていることを示している。また、同じ種類の反応であっても、反応パターン（関与する原子、結合、官能基）が類似している場合が多いため、反応タイプを事前知識として与えておけば、反応中心を認識することが容易になります。また、半テンプレートの重要性については、付録D.2で検証している。


## Table2結果
USPTO-50KのEGAT訓練データ（40K）に対してもP→S予測を行い、反応型条件設定の予測精度は89.0%  
増強サンプル(Aug)として約4Kの不成功シンソン予測を元の68Kの訓練データを加えると、総RGN訓練データサイズは72Kとなる。  
無条件設定では、EGATの精度は70.0%であり、オーグメンテーションサンプルは12Kあり、この場合のRGNの総学習サイズは80Kである。オーグメンテーション（Aug）の有無にかかわらず、USPTO-50KでRGNモデルを訓練し、結果を表2に報告します。

RGN評価では、入力はシンソンで構成されています。したがって、表2の結果は、我々の手法の全体的なレトロシンセシス性能の上限を示している。増強戦略は、必ずしも上限値を改善するとは限らない。  
反応タイプが与えられていない場合、RGNはダーティな訓練サンプルのため、より悪い性能を発揮します。  
しかし，反応タイプが与えられている場合は予測精度が向上する．  
これは反応の種類が重要な役割を果たしているからと推測されます。  
RGNはシンソンの代わりに、反応タイプと生成物にもっと注意を払うように学習します。


## Table3
レトロシンセシス予測精度を評価するために、P → Sから生成されたシントンをRGNに入力する。  
我々の手法RetroXpertは、試験データに対して高い性能を達成している。  
反応の種類が与えられた場合，提案手法は70.4%のTop-1精度を達成しており，SOTAのTop-1精度63.2% [5]を大差で上回っている．Top-1精度70.4%は，表2の上限値73.4%にかなり近い値であり，Robustify the RGNで提案したオーグメンテーション戦略がかなり有効であることを示している．  
反応タイプを指定した場合のSOTA Top-1精度は52.6% [5]から65.6%に向上した．オーグメンテーションの有効性を検証するために，アブレーション試験を実施し，その結果を付録D.3に報告する．

我々の手法はTop-1、Top-3、Top-5の精度では優れていますが、GLN [5]とRetroSim [12]は、ヒット率を高めるために各生成物に対して複数の異なる反応テンプレートを列挙するため、Top-20とTop-50の予測ではより優れています。  
RetroXpertは反応物の最適セットを見つけるように設計されていますが、多様性を高めるために複数の反応中心を列挙する新しい戦略を設計することができます。  
Top-2とTop-1の精度の差が10%程度であることに気づく（他より小さい）。この10%の予測を合成化学の観点から経験豊富な化学者に調査してもらったところ、Top-1の予測は約9/10が妥当であることがわかりました（詳細は付録Eを参照）。このことは我々の手法が一般的な化学反応の知識を学習できることを示している。  
[12]分子類似性に基づいて合成経路を提案

> broader impact<br>

<br>

RetroXpertは、化学者が行うような2段階のステップでレトロ合成の予測を解くことができ、非常に優れた性能を実現  
テンプレートフリーであり、実世界の大規模なデータセットへの拡張性にも優れる  
私たちの成果は、前方反応予測や創薬などの関連研究を大きく刺激し、前進させるものと信じています。  
創薬の研究者や産業界の専門家は、この研究から最も恩恵を受けることができるでしょう。  
この研究で不利益を被る人がいるとは考えていません。私たちの方法はデータの偏りを利用しないので、一般的で拡張性があります。
***

> discussion

<br>

現在の逆合成研究の大きな共通の限界の一つは、合理的な評価基準がない。  
現在の評価基準は与えられた反応のみを考慮しているのに対し、製品を合成するためには複数の有効な方法があるかもしれません。  
将来的には、より多くの評価基準が提案されるべきである。